<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Tasks - 云同步任务管理</title>
    <!-- 引入 Tailwind CSS 和 Google Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- 引入 Lucide 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 引入 Firebase Compat SDK (支持 file:// 协议) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --accent-color: #6366f1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .task-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .task-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-color);
        }

        .expanded-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .expanded-content.active {
            max-height: 500px;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        .completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .sync-indicator {
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* 配置引导弹窗 */
        #config-guide {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- 头部 -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-4">
            <div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Nexus Tasks</h1>
                <div class="flex items-center gap-4 mt-1">
                    <p class="text-slate-400 text-sm" id="current-date"></p>
                    <div id="sync-status" class="sync-indicator text-slate-500">
                        <i data-lucide="cloud-off" class="w-3 h-3"></i> 未连接
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="export-btn" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-sm transition-all border border-slate-700 text-slate-300">
                    <i data-lucide="download" class="w-4 h-4"></i> 导出 JSON
                </button>
                <button id="add-long-btn" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-lg text-sm transition-all border border-slate-700">
                    <i data-lucide="target" class="w-4 h-4"></i> 新增长期目标
                </button>
                <button id="add-daily-btn" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg text-sm transition-all font-medium">
                    <i data-lucide="plus" class="w-4 h-4"></i> 新增每日待办
                </button>
            </div>
        </header>

        <!-- 任务分布布局 -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <section class="lg:col-span-4 flex flex-col gap-4">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-lg font-semibold flex items-center gap-2 text-indigo-300">
                        <i data-lucide="calendar-range" class="w-5 h-5"></i> 长期目标
                    </h2>
                    <span id="long-count" class="text-xs bg-slate-800 px-2 py-1 rounded-full text-slate-400">0</span>
                </div>
                <div id="long-term-list" class="space-y-4 custom-scrollbar overflow-y-auto max-h-[70vh] pr-2"></div>
            </section>

            <section class="lg:col-span-8 flex flex-col gap-4">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-lg font-semibold flex items-center gap-2 text-emerald-300">
                        <i data-lucide="sun" class="w-5 h-5"></i> 每日待办
                    </h2>
                    <span id="daily-count" class="text-xs bg-slate-800 px-2 py-1 rounded-full text-slate-400">0</span>
                </div>
                <div id="daily-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 custom-scrollbar overflow-y-auto max-h-[70vh] pr-2"></div>
            </section>
        </div>
    </div>

    <!-- 弹窗 -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="glass w-full max-w-md mx-4 p-6 rounded-2xl shadow-2xl scale-95 transition-transform duration-300" id="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4">添加任务</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">任务名称</label>
                    <input type="text" id="task-input-title" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 text-white" placeholder="输入任务名称...">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">详细描述</label>
                    <textarea id="task-input-desc" rows="3" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 text-white" placeholder="添加补充说明..."></textarea>
                </div>
                <div id="relation-container">
                    <label class="block text-xs text-slate-400 mb-1">关联到长期目标</label>
                    <select id="task-input-relation" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 text-white">
                        <option value="">(不关联)</option>
                    </select>
                </div>
                <div class="flex gap-3 mt-6">
                    <button id="modal-cancel" class="flex-1 px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors">取消</button>
                    <button id="modal-save" class="flex-1 px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition-colors font-medium">保存任务</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 本地配置引导弹窗 -->
    <div id="config-guide" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80">
        <div class="glass w-full max-w-lg p-8 rounded-2xl border border-indigo-500/30">
            <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
                <i data-lucide="settings" class="text-indigo-400"></i> 本地初始化配置
            </h3>
            <p class="text-sm text-slate-400 mb-6">为了在本地保存数据，请提供你的 Firebase 配置 JSON 字符串。</p>
            <textarea id="local-config-input" rows="8" class="w-full bg-black/40 border border-slate-700 rounded-xl px-4 py-3 text-xs font-mono text-indigo-300 focus:outline-none focus:border-indigo-500 mb-4" placeholder='{"apiKey": "...", "authDomain": "...", ...}'></textarea>
            <div class="flex flex-col gap-2">
                <button id="save-local-config" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold transition-all">保存并启动应用</button>
                <p class="text-[10px] text-slate-500 text-center">配置将保存在本地 localStorage 中</p>
            </div>
        </div>
    </div>

    <script>
        // --- 初始化与兼容处理 ---

        let firebaseConfig = null;
        let appId = "nexus-tasks-default";
        let tasks = [];
        let user = null;
        let currentEditingId = null;
        let activeType = 'daily';

        // 检查配置源
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'nexus-tasks-default';
        } else {
            const savedConfig = localStorage.getItem('local_firebase_config');
            if (savedConfig) {
                firebaseConfig = JSON.parse(savedConfig);
            } else {
                document.getElementById('config-guide').style.display = 'flex';
                lucide.createIcons();
            }
        }

        // 渲染日期
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = new Intl.DateTimeFormat('zh-CN', options).format(new Date());

        // --- Firebase 操作 ---

        function initApp() {
            if (!firebaseConfig) return;

            // 初始化 Firebase Compat
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            const updateSyncStatus = (status) => {
                const el = document.getElementById('sync-status');
                if (!el) return;
                if (status === 'syncing') {
                    el.innerHTML = `<i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i> 同步中...`;
                    el.className = 'sync-indicator text-indigo-400';
                } else if (status === 'synced') {
                    el.innerHTML = `<i data-lucide="cloud-check" class="w-3 h-3"></i> 云端已同步`;
                    el.className = 'sync-indicator text-emerald-400';
                } else {
                    el.innerHTML = `<i data-lucide="cloud-off" class="w-3 h-3"></i> 连接异常`;
                    el.className = 'sync-indicator text-red-400';
                }
                lucide.createIcons();
            };

            // 认证 (遵守 RULE 3)
            const handleAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                } catch (err) {
                    console.error("Auth failed", err);
                    updateSyncStatus('error');
                }
            };

            auth.onAuthStateChanged((u) => {
                user = u;
                if (user) {
                    setupRealtimeListener(db);
                }
            });

            handleAuth();

            // 监听数据 (遵守 RULE 1 & 2)
            function setupRealtimeListener(db) {
                updateSyncStatus('syncing');
                const tasksRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks');
                
                tasksRef.onSnapshot((snapshot) => {
                    tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    tasks.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
                    renderUI(db);
                    updateSyncStatus('synced');
                }, (error) => {
                    console.error("Firestore error", error);
                    updateSyncStatus('error');
                });
            }

            // 暴露操作到全局以便 UI 调用
            window.dbInstance = db;
        }

        // --- UI 操作 ---

        function renderUI(db) {
            const longTermList = document.getElementById('long-term-list');
            const dailyList = document.getElementById('daily-list');
            const relationSelect = document.getElementById('task-input-relation');

            longTermList.innerHTML = '';
            dailyList.innerHTML = '';
            relationSelect.innerHTML = '<option value="">(不关联)</option>';

            let longCount = 0;
            let dailyCount = 0;

            tasks.forEach(task => {
                if (task.type === 'long') {
                    const opt = document.createElement('option');
                    opt.value = task.id;
                    opt.textContent = task.title;
                    relationSelect.appendChild(opt);
                }

                const card = document.createElement('div');
                card.className = `task-card glass p-4 rounded-xl border border-slate-700 animate-fade-in ${task.completed ? 'completed' : ''}`;
                
                const parentTask = tasks.find(t => t.id === task.parentId);
                const relationTitle = parentTask ? parentTask.title : null;

                const checkId = `task-check-${task.id}`;
                const titleId = `task-title-${task.id}`;
                const editId = `task-edit-${task.id}`;
                const delId = `task-del-${task.id}`;
                const descId = `task-desc-${task.id}`;

                card.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex items-start gap-3 flex-1 overflow-hidden">
                            <input type="checkbox" ${task.completed ? 'checked' : ''} id="${checkId}"
                                class="mt-1 w-5 h-5 rounded border-slate-700 bg-slate-900 text-indigo-600 focus:ring-offset-0 focus:ring-0 cursor-pointer">
                            <div class="flex-1 cursor-pointer" id="${titleId}">
                                <h3 class="font-medium truncate text-slate-100">${task.title}</h3>
                                ${relationTitle ? `
                                    <span class="inline-flex items-center text-[10px] text-indigo-400 bg-indigo-400/10 px-1.5 py-0.5 rounded mt-1">
                                        <i data-lucide="link" class="w-2.5 h-2.5 mr-1"></i>${relationTitle}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button id="${editId}" class="p-1.5 text-slate-500 hover:text-indigo-400 transition-colors">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button id="${delId}" class="p-1.5 text-slate-500 hover:text-red-400 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div id="${descId}" class="expanded-content mt-3">
                        <p class="text-sm text-slate-400 border-t border-slate-800 pt-3 whitespace-pre-wrap">${task.desc || '暂无详细内容'}</p>
                    </div>
                `;

                if (task.type === 'long') {
                    longTermList.appendChild(card);
                    longCount++;
                } else {
                    dailyList.appendChild(card);
                    dailyCount++;
                }

                // 事件绑定
                setTimeout(() => {
                    document.getElementById(checkId).onchange = () => toggleComplete(task.id);
                    document.getElementById(titleId).onclick = () => toggleExpand(task.id);
                    document.getElementById(editId).onclick = () => openModal(task.type, task.id);
                    document.getElementById(delId).onclick = () => deleteTask(task.id);
                }, 0);
            });

            document.getElementById('long-count').innerText = longCount;
            document.getElementById('daily-count').innerText = dailyCount;
            lucide.createIcons();
        }

        async function saveTask() {
            if (!user || !window.dbInstance) return;
            const title = document.getElementById('task-input-title').value.trim();
            const desc = document.getElementById('task-input-desc').value.trim();
            const parentId = document.getElementById('task-input-relation').value;

            if (!title) return;

            const id = currentEditingId || Date.now().toString();
            const taskData = {
                title,
                desc,
                type: activeType,
                completed: currentEditingId ? tasks.find(t => t.id === currentEditingId).completed : false,
                parentId: activeType === 'daily' ? parentId : null,
                updatedAt: Date.now()
            };

            await window.dbInstance.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks').doc(id).set(taskData);
            closeModal();
        }

        async function toggleComplete(id) {
            const task = tasks.find(t => t.id === id);
            await window.dbInstance.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks').doc(id).update({ 
                completed: !task.completed,
                updatedAt: Date.now()
            });
        }

        async function deleteTask(id) {
            await window.dbInstance.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks').doc(id).delete();
        }

        function openModal(type, id = null) {
            activeType = type;
            currentEditingId = id;
            document.getElementById('relation-container').style.display = type === 'long' ? 'none' : 'block';
            if (id) {
                const task = tasks.find(t => t.id === id);
                document.getElementById('modal-title').innerText = '编辑任务';
                document.getElementById('task-input-title').value = task.title;
                document.getElementById('task-input-desc').value = task.desc;
                document.getElementById('task-input-relation').value = task.parentId || '';
            } else {
                document.getElementById('modal-title').innerText = type === 'long' ? '新增长期目标' : '新增每日待办';
                document.getElementById('task-input-title').value = '';
                document.getElementById('task-input-desc').value = '';
                document.getElementById('task-input-relation').value = '';
            }
            document.getElementById('modal').classList.remove('pointer-events-none', 'opacity-0');
            document.getElementById('modal-content').classList.remove('scale-95');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('pointer-events-none', 'opacity-0');
            document.getElementById('modal-content').classList.add('scale-95');
        }

        function toggleExpand(id) {
            document.getElementById(`task-desc-${id}`).classList.toggle('active');
        }

        // --- 绑定事件 ---

        document.getElementById('add-daily-btn').onclick = () => openModal('daily');
        document.getElementById('add-long-btn').onclick = () => openModal('long');
        document.getElementById('modal-cancel').onclick = closeModal;
        document.getElementById('modal-save').onclick = saveTask;
        document.getElementById('export-btn').onclick = () => {
            const blob = new Blob([JSON.stringify(tasks, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = `nexus_tasks_backup.json`;
            a.click();
        };

        // 处理本地配置保存
        document.getElementById('save-local-config').onclick = () => {
            const input = document.getElementById('local-config-input').value;
            try {
                JSON.parse(input);
                localStorage.setItem('local_firebase_config', input);
                location.reload();
            } catch (e) {
                alert("无效的 JSON 格式，请检查。");
            }
        };

        // 启动
        if (firebaseConfig) initApp();
        lucide.createIcons();

    </script>
</body>
</html>